
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat → Piano (OkPlonk 88 notes)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f1630;--accent:#94e2ff;--muted:#9aa4b2}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%,#0e1740,#0a1024);color:#e8eef7;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;padding:20px;display:flex;justify-content:center}
    .app{width:100%;max-width:980px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.55);padding:16px}
    h1{font-size:20px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    button{background:linear-gradient(180deg,#0f1b3d,#0c1530);border:1px solid rgba(255,255,255,0.08);color:#e8eef7;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .piano{position:relative;height:180px;user-select:none;display:flex; background:#0b1229;border-radius:10px;padding:8px}
    .white{width:calc(100%/52);height:100%;background:#f2f4f8;border:1px solid #cfd7e3;position:relative}
    .white.active{background:#dbe7ff}
    .black{position:absolute;top:8px;height:60%;width:calc(100%/52 * .62);background:#1b2330;border:1px solid #0b1220;z-index:2;transform:translateX(-50%)}
    .black.active{background:#2f3c55}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Chat → Piano (OkPlonk 88 notes fixes)</h1>
      <div class="muted">Connexion automatique au chat public <code>okplonk</code>. Lettres accentuées fusionnées. Symboles ajoutés pour 88 notes.</div>
      <button id="audio">Activer l'audio</button>
      <span id="state" class="muted">Audio inactif · Connexion...</span>
      <div id="lastmsg" style="margin-top:10px;color:#9ee;font-family:monospace;white-space:pre-wrap"></div>
    </div>
    <div class="card"><div id="piano" class="piano"></div></div>
  </div>

  <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <script>
    const CHAR_SET = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','.',',','?','!',':',';','(',')','[',']','{','}','@','#','%','&','*','+','-','=','/','<','>','^','~','_','|','$','80','81','82','83','84','85','86','87'];

    const accentMap = {
      'à':'a','á':'a','â':'a','ä':'a','ã':'a','å':'a',
      'ç':'c','è':'e','é':'e','ê':'e','ë':'e',
      'ì':'i','í':'i','î':'i','ï':'i',
      'ñ':'n','ò':'o','ó':'o','ô':'o','ö':'o','õ':'o',
      'ù':'u','ú':'u','û':'u','ü':'u','ÿ':'y',
      'À':'A','Á':'A','Â':'A','Ä':'A','Ã':'A','Å':'A',
      'Ç':'C','È':'E','É':'E','Ê':'E','Ë':'E',
      'Ì':'I','Í':'I','Î':'I','Ï':'I',
      'Ñ':'N','Ò':'O','Ó':'O','Ô':'O','Ö':'O','Õ':'O',
      'Ù':'U','Ú':'U','Û':'U','Ü':'U','Ÿ':'Y'
    };

    let actx=null, master=null; const heldNodes=new Set();
    function ensureAudio(){ if(actx) return true;
      try{ actx=new(window.AudioContext||window.webkitAudioContext)(); master=actx.createGain();
        master.gain.value=0.35; master.connect(actx.destination); setState(); return true; }
      catch(e){ alert('AudioContext non supporté'); return false; }
    }
    function noteFreq(i){ const n=i+1; return 440*Math.pow(2,(n-49)/12); }
    function playKey(i){ if(!actx)return;
      if(heldNodes.size>=16){ const f=heldNodes.values().next().value; try{f.stop();}catch{} heldNodes.delete(f); }
      const osc=actx.createOscillator(); const g=actx.createGain();
      osc.type='triangle'; osc.frequency.value=noteFreq(i);
      const t=actx.currentTime,a=0.004,r=0.08;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.9,t+a);
      g.gain.exponentialRampToValueAtTime(0.0008,t+a+r);
      osc.connect(g); g.connect(master); osc.start(t); osc.stop(t+a+r+0.01);
      heldNodes.add(osc); osc.onended=()=>heldNodes.delete(osc); flashKey(i);
    }
    const pianoEl=document.getElementById('piano'); const keyEls=[];
    (function buildPiano(){
      for(let i=0;i<52;i++){const w=document.createElement('div');w.className='white';pianoEl.appendChild(w);}
      const ww=()=>pianoEl.getBoundingClientRect().width/52;
      function place(){keyEls.length=0;pianoEl.querySelectorAll('.black').forEach(b=>b.remove());
        let wi=0;for(let k=0;k<88;k++){const p=(k+9)%12;const isB=(p==1||p==3||p==6||p==8||p==10);
          if(isB){const x=wi*ww();const b=document.createElement('div');b.className='black';b.style.left=x+'px';pianoEl.appendChild(b);keyEls[k]=b;}
          else{const w=pianoEl.children[wi];keyEls[k]=w;wi++;}
        }
      }
      new ResizeObserver(place).observe(pianoEl); place();
    })();
    function flashKey(i){const e=keyEls[i];if(!e)return;e.classList.add('active');setTimeout(()=>e.classList.remove('active'),120);}

    let client=null;
    async function connectChat(){
      if(client) try{await client.disconnect();}catch{}
      client=new tmi.Client({connection:{secure:true,reconnect:true},channels:['okplonk']});
      client.on('message',(chan,tags,msg,self)=>{if(self)return;trigger(msg);});
      client.on('connected',()=>setState('connected')); client.on('disconnected',()=>setState('disconnected'));
      try{await client.connect();}catch(e){console.error(e);}
    }

    function normalizeChar(c){return accentMap[c]||c;}
    function trigger(txt){if(!ensureAudio())return;
      document.getElementById('lastmsg').textContent=txt;
      let d=0; for(const raw of Array.from(txt)){const c=normalizeChar(raw);const i=CHAR_SET.indexOf(c);
        if(i!==-1){setTimeout(()=>playKey(i),d*1000);d+=0.04;}}
    }

    document.getElementById('audio').addEventListener('click',()=>{if(ensureAudio())actx.resume();});
    function setState(status){const s=document.getElementById('state');
      let state='Audio '+(actx?(actx.state==='running'?'actif':'prêt'):'inactif');
      if(status==='connected')state+=' · Connecté au chat okplonk';
      else if(status==='disconnected')state+=' · Déconnecté';
      else state+=' · Connexion...';
      s.textContent=state;}
    connectChat();
  </script>
</body>
</html>
